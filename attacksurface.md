
# LBU-LTI-Tools Attack Surface

All URLs are relative to a base URL of:

```https://servername/lbu-lti-tools/```

A bare list of URLs;

* /login
* /launch
* /jwks
* /autoreg
* /deeplinking/index.jsp?state_id=_random_&nonce=_random_
* /peergroupassessment/index.jsp?state_id=_random_&nonce=_random_
* /selfenrol/index.jsp?state_id=_random_&nonce=_random_
* /socket/deeplinking?state_id=_random_&nonce=_random_
* /socket/peergroupassessment?state_id=_random_&nonce=_random_
* /socket/selfenrol?state_id=_random_&nonce=_random_

## Servlets

### Login Servlet `/login`

For access by user via browser.

Implements the IMS LTI Advantage standard login functionality. Works a little like a single 
sign-on entry point. Platform forwards user to this URL, passing in form fields to identify the
platform. Servlet looks up security provider and forwards user to URL or prints error message.
This servlet generates a `state` ID and initiates a state structure within a state store.

### Launch Servlet `/launch`

For access by user via browser.

Receives a digitally signed set of claims from platform in JWT format.
Either displays error message or forwards user to a Java Server Page selected based on the
claims.

### JWKS Servlet `/jwks`

For access by other servers in the LTI eco system. Simply returns a JSON formated text file
containing the public keys used by this service. The basis of the trust for these keys is the
HTTPS server certificate.

### Auto registration Servlet `/autoreg`

Used by platform when platform sysadmin registers the platform with our provider. Uses IMS
LTI auto registration mechanism.

## Java Server Pages

All JSP pages are accessed by users' web browsers after a launch process. Each JSP URL takes
a two parameter query string `state_id` and `nonce`. The value of `state_id` is generated by the IMS Login
servlet. The nonce is a random string generated by the launch servlet. (Which differs from the 
nonce used as part of the IMS launch protocol.)

Delivers HTML customised based on state with accompanying javascript. The javascript
establishes a WebSocket connection to a tool-specific endpoint and functionality is implemented 
by message passing between browser and server.


### Deep Linking `/deeplinking/index.jsp?state_id=...&nonce=...`

Presents user with tools and/or resources which can be created/selected and linked to
from the platform.

### Peer Group Assessment `/peergroupassessment/index.jsp?state_id=...&nonce=...`

Presents user with user interface and forms for recording group peer assessment marks. The
tool can be multiply-instantiated. The ID of the instance is recorded in the state structure.
Functionality varies depending on role of user. 

### Self Enrol `/selfenrol/index.jsp?state_id=...&nonce=...`

Presents the user with search tools for course modules and allows them to self-enrol. This is
a singleton tool. (Cannot be multiply-instantiated.)

## WebSockets

All WebSockets are accessed by users' web browsers after a launch process. Each WebSocket endpoint 
URL takes a two parameter query string `state_id` and `nonce`. The value of `state_id` is generated by the IMS Login
servlet. The nonce is different to the one given to the JSP page.

Messages are passed in either direction in JSON format like this:

```
toolmessageversion1.0
id:e42c7235-dba6-4668-a31d-c3188b6f11b6
replytoid:6916
messagetype:Resource
payloadtype:uk.ac.leedsbeckett.ltitools.peergroupassessment.resourcedata.PeerGroupResource
payload:
{
  "key" : {
    "platformId" : "moodle_devmoodle_07be3b34e902992761096f89ce824659",
    "resourceId" : "37"
  },
  "properties" : {
    "title" : "Initial Title",
    "description" : "Initial Description",
    "stage" : "SETUP"
  },
  "groupsById" : { },
  "groupOfUnattached" : {
    "id" : null,
    "title" : null,
    "externalId" : null,
    "membersbyid" : { }
  },
  "groupIdsByMember" : { },
  "groupIdsInOrder" : [ ],
  "groupIdsByExternalId" : { }
}
```

Server to client and client to server messages are documented in source code. Handler methods in
the endpoint Java class annotated with EndpointMessageHandler define client to server messages. Two
parameter methods are for messages without payload and three parameter methods are for messages
with payload. The EndpointJavascriptProperties annotation for the endpoint Java class specifies
a Java enumeration that defines all possible server to client messages.

Therefore the sourcecode is mostly self documenting with regard to the API implemented.

### Deep Linking `/socket/deeplinking?state_id=...&nonce=...`

Client to server messages: 2
Server to client messages: 3

Documented by:
https://github.com/leeds-beckett-digital-learning/lbu-lti-toolapi/blob/main/src/main/java/uk/ac/leedsbeckett/ltitoolset/deeplinking/DeepLinkingEndpoint.java
and
https://github.com/leeds-beckett-digital-learning/lbu-lti-toolapi/blob/main/src/main/java/uk/ac/leedsbeckett/ltitoolset/deeplinking/DeepServerMessageName.java

### Peer Group Assessment `/socket/peergroupassessment?state_id=...&nonce=...`

Client to server messages: 15
Server to client messages: 8

Documented by:
https://github.com/leeds-beckett-digital-learning/lbu-lti-tools/blob/main/src/main/java/uk/ac/leedsbeckett/ltitools/peergroupassessment/PgaEndpoint.java
and
https://github.com/leeds-beckett-digital-learning/lbu-lti-tools/blob/main/src/main/java/uk/ac/leedsbeckett/ltitools/peergroupassessment/PgaServerMessageName.java


### Self Enrol `/socket/selfenrol?state_id=...&nonce=...`

Client to server messages: 2
Server to client messages: 3

Documented by:
https://github.com/leeds-beckett-digital-learning/lbu-lti-tools/blob/main/src/main/java/uk/ac/leedsbeckett/ltitools/selfenrol/SeEndpoint.java
and
https://github.com/leeds-beckett-digital-learning/lbu-lti-tools/blob/main/src/main/java/uk/ac/leedsbeckett/ltitools/selfenrol/SeServerMessageName.java
